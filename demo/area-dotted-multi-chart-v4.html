<!DOCTYPE html>
<html class=''>
<head>

    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <link href="../css/carma.css" rel="stylesheet">
    <link href="../css/style.css" rel="stylesheet">
    <link href="../css/charts.css" rel="stylesheet">

    <!-- moment.js -->
    <script src="../js/moment.min.js"></script>

    <style class="cp-pen-styles">.d3 {
        box-shadow: 0 0 0 1px #eee;
        box-sizing: border-box;
    }

    path,
    line {
        fill: none;
        shape-rendering: crispEdges;
        stroke: #E8E8E8;
    }

    .path-line {
        shape-rendering: initial;
    }
    .path-line.path-line1 {
        stroke: #0baadd;
    }
    .path-line.path-line2 {
        stroke: #47cf73;
    }

    .path-area {
        stroke: none;
    }
    .path-area.path-area1 {
        fill: rgba(11, 170, 221, 0.7);
        stroke: rgba(11, 170, 221, 0.7);
    }
    .path-area.path-area2 {
        fill: rgba(71, 207, 115, 0.55);
        stroke: rgba(71, 207, 115, 0.55);
    }

    .tick text {
        font-family: sans-serif;
        font-size: 10px;
        fill: #999;
    }



    .tooltip {
        font: 14px sans-serif;
        line-height: 1;
        font-weight: bold;
        padding: 6px 12px;
        background: rgba(0, 0, 0, 0.8);
        color: #fff;
        border-radius: 2px;
        font-family: inherit;
        pointer-events:none; /*let mouse events pass through*/
        opacity:0;
        transition: opacity 0.3s;
        width: auto;
        position: absolute;
    }

    .tooltip:before {
        border-top: 5px solid transparent;
        border-bottom: 5px solid transparent;
        border-right:5px solid rgba(0, 0, 0, 0.8);
        right: 100%;
        content: '';
        top: 10px;
        position: absolute;
        z-index: 99;
    }

    .tooltip-title { display: block; color: orange; }

    </style>
</head>
<body>

<div class="area-chart-container">
    <svg class="line-graph"></svg>
    <div class="tooltips"> <div class="tooltip"></div></div>

</div>

<script>

var graphContainer = d3.select('.area-chart-container');
var svg = d3.select('svg');
var margin = { top: 50, right: 50, bottom: 50, left: 50 };
var duration = 500;
var durationIncrease = 100;
var width = undefined,
    height = undefined,
    innerWidth = undefined,
    innerHeight = undefined;
var xScale = undefined,
    yScale = undefined;


var parseTime = d3.timeParse("%Y-%m-%d");
var data = [
    {
        "date":parseTime("2017-07-07"),
        "media":[
            {
                "type":"newspaper",
                "count":70
            },
            {
                "type":"magazine",
                "count":80
            },
            {
                "type":"website",
                "count":40
            },
            {
                "type":"blogs",
                "count":0
            }
        ]
    },
    {
        "date":parseTime("2017-07-06"),
        "media":[
            {
                "type":"newspaper",
                "count":40
            },
            {
                "type":"magazine",
                "count":85
            },
            {
                "type":"website",
                "count":70
            },
            {
                "type":"blogs",
                "count":20
            }
        ]
    },
    {
        "date":parseTime("2017-07-05"),
        "media":[
            {
                "type":"newspaper",
                "count":20
            },
            {
                "type":"magazine",
                "count":63
            },
            {
                "type":"website",
                "count":40
            },
            {
                "type":"blogs",
                "count":15
            }
        ]
    },
    {
        "date":parseTime("2017-07-04"),
        "media":[
            {
                "type":"newspaper",
                "count":98
            },
            {
                "type":"magazine",
                "count":59
            },
            {
                "type":"website",
                "count":78
            },
            {
                "type":"blogs",
                "count":0
            }
        ]
    },
    {
        "date":parseTime("2017-07-03"),
        "media":[
            {
                "type":"newspaper",
                "count":40
            },
            {
                "type":"magazine",
                "count":85
            },
            {
                "type":"website",
                "count":70
            },
            {
                "type":"blogs",
                "count":20
            }
        ]
    }];



var datasets = [];
var labels = [];
var legends = [];


var datas = [];

//Set Media Type Series
$(data[0].media).each(function(i) {
    legends.push(data[0].media[i].type);
    datasets.push([]);


    datas.push({ id: data[0].media[i].type, values : []});
});

//Set Values
for(var i=data.length - 1; i >= 0; i--){

    labels.push(data[i].date);

    $(data[i].media).each(function(index) {
        datasets[index].push(this.count);


        datas[index].values.push({close: this.count, date: data[i].date});
    });
}

var DATA1 = datasets[0];//[9.5, 2, 5, 7, 5, 3, 0];
var DATA2 = datasets[1]; //[15, 7, 6, 8, 6, 2, 1];
var LABELS = labels; //['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

var xAxisLabels = undefined;

(function init() {
    getDimentions();
    getScaleDomains();
    getScaleRanges();
    renderPlot();
    drawGraph();
})();

d3.select(window).on('resize', resize);

function resize() {
    destroyGraph();
    getDimentions();
    getScaleRanges();
    renderPlot();
    drawGraph();
}

function renderPlot() {


    xAxisLabels = d3.scaleTime()
        .rangeRound([0, innerWidth], 0)
        .domain(d3.extent(data, function(d) { return d.date; }));

    x = d3.axisBottom(xAxisLabels).ticks(data.length);

    y = d3.axisLeft(yScale).ticks(4);

    svg.attr('width', width).attr('height', height);

    var inner = svg.selectAll('g.inner').data([null]);
    inner.exit().remove();
    inner.enter().append('g')
        .attr('class', 'inner')
        .attr('transform', 'translate(' + margin.top + ', ' + margin.right + ')');

    var horizontalLineGroup = svg.selectAll('g.inner').selectAll('.line-group').data([null]);
    horizontalLineGroup.exit().remove();
    horizontalLineGroup.enter().append('g')
        .attr('class', 'line-group');

    var horizontalLine = svg.selectAll('g.line-group').selectAll('.grid-line').data(yScale.ticks(4));
    horizontalLine.exit().remove();
    horizontalLine.enter().append('line')
        .attr('class', 'grid-line')
        .attr('x1', 0)
        .attr('x2', innerWidth)
        .attr('y1', function (d) {
            return yScale(d);
        }).attr('y2', function (d) {
            return yScale(d);
        });


    var xLabel = 'Names';

    var yLabel = 'Count';

    var xAxis = svg.selectAll('g.inner').selectAll('g.x.axis').data([null]);
    xAxis.exit().remove();
    xAxis.enter().append('g')
        .attr('class', 'x axis')
        .attr('transform', 'translate(0, ' + innerHeight + ')')
        .call(x)
        .append('text')
        .attr('x', (innerWidth / 2))
        .attr('y', 25)
        .attr('dy', '.71em')
        .style('text-anchor', 'middle')
        .text(xLabel);

    var yAxis = svg.selectAll('g.inner').selectAll('g.y.axis').data([null]);
    yAxis.exit().remove();
    yAxis.enter().append('g')
        .attr('class', 'y axis')
        .call(y)
        .append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", -45)
        .attr("x", -(innerHeight / 2))
        .attr("dy", ".71em")
        .style("text-anchor", "middle")
        .text(yLabel);


}

function drawGraph(){

    // define the line
    var line = d3.line()
        .curve(d3.curveCatmullRom)
        .x(function(d) { return xScale(d.date); })
        .y(function(d) { return yScale(d.close); });

    var area = d3.area()
        .curve(d3.curveCatmullRom)
        .x(function(d) { return xScale(d.date); })
        .y0(innerHeight)
        .y1(function(d) { return yScale(d.close); });

    var line2 = d3.line().x(function (d, i) {
        return xScale(labels[i]);
    }).y(function (d) {
        return yScale(d);
    }).curve(d3.curveCatmullRom);

    var area2 = d3.area().x(function (d, i) {
        return xScale(labels[i]);
    }).y0(innerHeight).y1(function (d) {
        return yScale(d);
    }).curve(d3.curveCatmullRom);

    for(var i = 0; i <= datas.length - 1; i++){
        var pathLine2 = svg.selectAll('g.inner').selectAll('.chart_line_' + i).data([null]);
        pathLine2.exit().remove();
        pathLine2.enter().append('path')
            .attr('class', 'path-line chart_line_' + i)
            .attr('d', function () {
                return line(createZeroDataArray(datas[i].values));
            })
            .transition()
            .duration(duration)
            .delay(durationIncrease * i)
            .ease(d3.easePoly.exponent(2)).attr('d', function () {
                return line(datas[i].values);
            });

        var pathArea2 = svg.selectAll('g.inner').selectAll('chart_fill_trans_' + i).data([null]);
        pathArea2.exit().remove();
        pathArea2.enter().append('path')
            .attr('class', 'path-area chart_fill_trans_' + i)
            .attr('d', function () {
                return area(createZeroDataArray(datas[i].values));
            })
            .transition()
            .duration(duration)
            .delay(durationIncrease * i)
            .ease(d3.easePoly.exponent(2))
            .attr('d', area(datas[i].values));


        var dots = svg.selectAll('g.inner').selectAll(".chart_dot_" +i)
            .data(datas[i].values)
            .enter().append("circle") // Uses the enter().append() method
            .attr("class", "dot chart_dot_" +i) // Assign a class for styling
            .attr("cx", function(d, i) { return xScale(d.date); })
            .attr("cy", innerHeight)
            .attr("r", 3)
            .transition()
            .duration(duration)
            .delay(durationIncrease * i)
            .ease(d3.easePoly.exponent(2))
            .attr("cy", function(d) { return yScale(d.close); });
    }

    var tooltip = d3.select('.tooltip');
    var barSize = Math.round(innerWidth / (datas[0].values.length - 1));

svg.selectAll('g.inner').selectAll('grid-tooltip')
    .data(data)
    .enter()
    .append('rect')

    .attr('class', 'grid-tooltip chartTransparentFill')
    .attr('tooltip-index', i)
    .on('mouseover', function (d, i) {
        tooltip.style('opacity', 1);
    })
    .on('mousemove', function (d, i) {
        tooltip
            .html(getTooltip(d))
            .style('opacity', 1)
            .style("left", Math.max(0, d3.event.pageX + 15) + "px")
            .style("top", (d3.event.pageY - 15) + "px");
    })
    .on('mouseout', function (d, i) {
        tooltip.style('opacity', 0);
    })
    .attr('x', function (d,i) {
        return (barSize * i) - (barSize / 2);
    })
    .attr('y', function (d) {
        return 0;
    })

    .attr('width', function (d, i) {
        return i === 0 ? (barSize / 2) - 1 : barSize - 1;
    })
    .attr('height', function (d) {
        return innerHeight - 1;
    });
}

function getTooltip(d){
    var html = '<div class="tooltip-line"><span class="tooltip-title">' + moment(d.date).format('ddd DD MMM YYYY') + ': </span></div>';

    $(d.media).each(function(index) {
        html += '<div class="tooltip-line"><div class="tooltip-item"><div class="tooltip-bullet"></div><div class="item-name light-gray"><span>'+this.type+'</span></div></div><div class="value light-gray">'+this.count+'</div></div>';
    });
//China0
    return html;
}

function destroyGraph() {
    svg.selectAll('*').remove();
}

function getDimentions() {
    width = graphContainer.node().clientWidth;
    height = 300;
    innerWidth = width - margin.left - margin.right;
    innerHeight = height - margin.top - margin.bottom;
}

function getScaleRanges() {
    xScale.range([0, innerWidth]).paddingInner(1);
    yScale.range([innerHeight, 0]).nice();
}

function getScaleDomains() {

    var min = d3.min(datas, function(c) { return d3.min(c.values, function(d) { return d.close; }); });
    var max = d3.max(datas, function(c) { return d3.max(c.values, function(d) { return d.close; }); });
    xScale = d3.scaleBand().domain(labels);
    yScale = d3.scaleLinear()
        .domain([min, max]);
}

function createZeroDataArray(arr) {
    var newArr = [];
    arr.forEach(function (item, index) {
        return newArr[index] = {
            date  : item.date,
            close : 0
        };
    });
    return newArr;
}

</script>
</body></html>